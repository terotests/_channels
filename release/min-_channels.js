(function(){var t={},n=function(){var n=function(){!function(t){var n,e,i,r,o;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,a;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var u=0;u<o.length;u++){var f=o[u];f()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<a&&(h.fn(),h.nextTime=a+h.step),h.until&&h.until<a&&delete r[l]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,a,s,c){var u,f=this;if(!(f instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,r,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};e._classInfo={name:"later"},e.prototype=new n;var i=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,o=[],a=new Array(e);return this.then(function(){var t=r();return 0==n.length&&t.resolve([]),n.forEach(function(n,r){n.then?(o.push(n),n.then(function(n){a[r]=n,i++,i==e&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var o=i.length,a=!1,s=!1,c=0,u=[],f=e||{};return this.then(function(){var n=r();return i.forEach(function(e){e.then?(u.push(e),e.then(function(e){c++,a=t(e,f),(a&&!s||0==s&&o==c)&&(n.resolve(f),s=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new r(t,n),o=this;return 1==this._state&&e().asap(function(){o.fulfill(o.value())}),2==this._state&&e().asap(function(){o.reject(o.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},r=function(t,n,e,i,o,a,s,c){var u,f=this;if(!(f instanceof r))return new r(t,n,e,i,o,a,s,c);var l=[t,n,e,i,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=r._classInfo.name)return new u(t,n,e,i,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};r._classInfo={name:"_promise"},r.prototype=new i;var o=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t.addCommands=function(t,n){if(this.isArray(t)){var e=this;return t.forEach(function(t){e.addCommands(t)}),this}this._commands.push({fnCmd:t,fnFail:n,async:!0})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._commands||(this._commands=[],this.waitingList=[],this._index=0);var i=this;if(!n){var r=function(){i.step()};e().every(1/30,r)}}),t.step=function(){var t=this._index,n=this._commands.length;if(t!=n){for(var e=r(),i=e,o=r(),a=this;n>t;){var s=this._commands[t];!function(t){i=i.then(function(){var n=r();return t.fnCmd(function(){n.resolve(!0)},function(e){n.resolve(!0),t.fnFail&&t.fnFail(e)}),n}).fail(function(n){t.fnFail&&t.fnFail(n)})}(s),this._index++,t++}return i.then(function(){if(a.waitingList.shift(),o.resolve(!0),a.waitingList.length){var t=a.waitingList[0];t.resolve(!0)}}).fail(function(){}),this.waitingList.push(e),1==this.waitingList.length&&e.resolve(!0),o}}}(this)},a=function(t,n,e,i,r,o,s,c){var u,f=this;if(!(f instanceof a))return new a(t,n,e,i,r,o,s,c);var l=[t,n,e,i,r,o,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=a._classInfo.name)return new u(t,n,e,i,r,o,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};a._classInfo={name:"sequenceStepper"},a.prototype=new o;var s=function(){!function(t){t.addSocketToCh=function(t,n){this._channelSockets[t]||(this._channelSockets[t]=[]),this._channelSockets[t].indexOf(n)<0&&this._channelSockets[t].push(n)},t.getSocketsFromCh=function(t){return this._channelSockets[t]?this._channelSockets[t]:[]},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){this._server=t,this._auth=e,this._channelSockets={};var i=this;this._server.on("connect",function(t){var r,o=[];t.on("requestChannel",function(e,a){n.findPath(e.channelId).then(function(s){s?(r=h(e.channelId,n,i),r.then(function(){r._groupACL(t,"r")?(t.join(e.channelId),i.addSocketToCh(e.channelId,t),o.push(e.channelId),a({success:!0,channelId:e.channelId})):a({success:!1,channelId:null})})):a({success:!1,channelId:null})})}),t.on("disconnect",function(){o.forEach(function(n){i.removeSocketFromCh(n,t)})}),t.on("auth",function(n,i){e?e.login(n.userId,n.password).then(function(n){if(n.result===!0){var e=n.userId,r=n.groups;console.log("AUTH groups ",n.groups),t.setAuthInfo(e,r),i({success:!0,userId:t.getUserId(),groups:n.groups})}else i({success:!1,userId:null})}):i({success:!1,userId:null})}),t.on("channelCommand",function(n,e){return t.getUserId()?t.isInRoom(n.channelId)?void r.run(n,function(t){e&&e(t)},t):void e({success:!1,reason:"not in room"}):void e({success:!1,reason:"socket is not authenticated."})})})}),t.removeSocketFromCh=function(t,n){if(this._channelSockets[t]){var e=this._channelSockets[t].indexOf(n);e>=0&&this._channelSockets[t].splice(e,1)}}}(this)},c=function(t,n,e,i,r,o,a,s){var u,f=this;if(!(f instanceof c))return new c(t,n,e,i,r,o,a,s);var l=[t,n,e,i,r,o,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=c._classInfo.name)return new u(t,n,e,i,r,o,a,s)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};c._classInfo={name:"_serverChannelMgr"},c.prototype=new s,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverChannelMgr=c,this._serverChannelMgr=c):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverChannelMgr=c:this._serverChannelMgr=c}.call(new Function("return this")());var u=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return n||(n={}),t+=e.id(),n[t]?n[t]:void(n[t]=this)}),t._createChannelDir=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var e=n.split("/"),i=this._fs,o=i,a=r(),s=a,c=this;return e.forEach(function(t){t=t.trim(),0!=t.length&&(a=a.then(function(){return o.isFolder(t)}).then(function(n){return n?!0:o.createDir(t)}).then(function(){return o.getFolder(t)}).then(function(t){o=t}))}),a=a.then(function(){c._folder=o}),s.resolve(!0),a},t._createChannelSettings=function(){var t=this._folder,n=this;return r(function(e){var i=!1;t.isFile("ch.settings").then(function(e){return e?!0:(i=!0,t.writeFile("ch.settings",JSON.stringify({version:1,name:"Initial version",utc:(new Date).getTime(),channelId:n._channelId,journalLine:0})))}).then(function(){return t.readFile("ch.settings")}).then(function(t){var i=JSON.parse(t);n._settings=i,e(n._settings)})})},t._isFreeToFork=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var e=n.split("/"),i=this._fs,o=i,a=r(),s=a,c=!1;return e.forEach(function(t){t=t.trim(),0!=t.length&&(a=a.then(function(){return c?c:o.isFolder(t)}).then(function(t){return c?void 0:t?c:c=!0}).then(function(){return c?c:o.getFolder(t)}).then(function(t){return c?c:void(o=t)}))}),a=a.then(function(){return c}),s.resolve(!0),a},t._textLinesToArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t._writeSettings=function(){return this._folder.writeFile("ch.settings",JSON.stringify(this._settings))},t.childForkTree=function(){var t=(this._folder,this);return r(function(n){t.getForks().then(function(e){var i=[],o=[];if(!e||0==e.length)return void n([]);e.forEach(function(n){var e=f(n.to,t._fs);i.push(e.childForkTree())});var a=r();a.all(i).then(function(t){e.forEach(function(n,e){n.children=t[e],o.push(n)}),n(o)}),a.resolve(!0)})})},t.fork=function(t){var n=this._folder,e=this;return r(function(i){var r=e._settings,o=r.journalLine||0;"undefined"!=typeof t.journalLine&&(o=t.journalLine);var a={fromJournalLine:o,version:1,channelId:t.channelId,fromVersion:r.version,from:e._channelId,to:t.channelId,name:t.name,utc:(new Date).getTime()};console.log("fork called with "),console.log(a),e._isFreeToFork(t.channelId).then(function(r){1==r?n.appendFile("forks",JSON.stringify(a)+"\n").then(function(){var n=f(t.channelId,e._fs);n.then(function(){return n.set(a)}).then(function(){i(a)})}):(console.error("Channel already created"),i({result:!1,text:"Channel is already in use"}))}).fail(function(t){console.error(t),i({result:!1,text:"Creating the fork failed"})})})},t.get=function(t){var n=this._db,e=this;return r(function(i){e.then(function(){var e=n.table("settings");e.get(t).then(function(t){i(t.value)})})})},t.getCurrentVersion=function(){var t=(this._folder,this);return r(function(n){n(t._settings.version)})},t.getForks=function(){var t=this._folder,n=this;return r(function(e){n.then(function(){return t.readFile("forks")}).then(function(t){e(t?n._textLinesToArray(t):[])}).fail(function(){e([])})})},t.incrementVersion=function(){var t=(this._folder,this);return r(function(n){t.then(function(){var e=t._settings;e.version++,e.journalLine=0,t._writeSettings().then(function(){n(e.version)})})})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._channelId=t,this._latestVersion=1,this._fs=n;var e=this;e._createChannelDir(t).then(function(){return e._createChannelSettings()}).then(function(){e.resolve(!0)}).fail(function(t){console.error(t)})}),t.readBuildTree=function(t,n,e){var i=(this._folder,this);return r(t?function(r){var o=f(t,i._fs);o.then(function(){o.readBuildTree(null,n,null).then(function(t){var n=t[0].length;n>e&&t[0].splice(e,n-e),r(t)})})}:function(t){var e,r,o=[];i.then(function(){return i.readMain(n)}).then(function(t){return t&&(e=JSON.parse(t)),i.readJournal(n)}).then(function(n){if(r=n,i._settings.from&&!e){var a=i._settings;i.readBuildTree(a.from,a.fromVersion,a.fromJournalLine).then(function(e){o.push(n),e.forEach(function(t){o.push(t)}),t(o)})}else t([n,e])}).fail(function(t){console.error(t)})})},t.readJournal=function(t){var n=this._folder,e=this,i=t||e._settings.version;return r(function(t){n.readFile("journal."+i).then(function(n){return n?void t(e._textLinesToArray(n)):void t([])}).fail(function(){t([])})})},t.readMain=function(t){var n=this._folder,e=this,i=t||e._settings.version;return 1==i?r(function(t){t(null)}):n.readFile("file."+i)},t.set=function(t,n){var e=(this._folder,this._settings);if(this.isObject(t))for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);else e[t]=n;return this._writeSettings(e)},t.snapshot=function(t){var n=(this._folder,this);return r(function(e){var i;n.incrementVersion().then(function(e){return i=e-1,n.writeMain(t)}).then(function(){e(!0)})})},t.status=function(){var t=(this._folder,this);return r(function(n){t.then(function(){n(t._settings)})})},t.treeOfLife=function(t){var n=(this._folder,this);if(t){var e=f(t,this._fs);return e.treeOfLife()}return r(function(t){n.then(function(){n._settings.from?n.treeOfLife(n._settings.from).then(t):n.childForkTree().then(t)})})},t.writeMain=function(t,n){var e=this._folder,i=this,r=n||i._settings.version;return"string"!=typeof t&&(t=JSON.stringify(t)),e.writeFile("file."+r,t)},t.writeToJournal=function(t){var n=this._folder,e=this;if(this.isArray(t[0])){var i="",o=0;return t.forEach(function(t){i+=JSON.stringify(t)+"\n",o++}),r(function(t){n.appendFile("journal."+e._settings.version,i).then(function(){e._settings.journalLine+=o,e._writeSettings(),t(!0)})})}return r(function(i){n.appendFile("journal."+e._settings.version,JSON.stringify(t)+"\n").then(function(){e._settings.journalLine++,e._writeSettings(),i(!0)})})}}(this)},f=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof f))return new f(t,n,e,i,r,o,a,s);var l=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,l)}),"function"==typeof c){if(c._classInfo.name!=f._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};u.prototype=r.prototype,f._classInfo={name:"_localChannelModel"},f.prototype=new u,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._localChannelModel=f,this._localChannelModel=f):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._localChannelModel=f:this._localChannelModel=f}.call(new Function("return this")());var l=function(){!function(t){var n,i;t._askChUpgrade=function(){var t=this._chManager.getSocketsFromCh(this._channelId),n=this;t.forEach(function(t){n._serverState.upgrade||(n._serverState.upgrade={}),n._serverState.upgrade[t.getId()]={askFull:!0,socket:t}})},t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return n||(n={}),t+=e.id(),n[t]?n[t]:void(n[t]=this)}),t._doClientUpdate=function(){var t,n=this;if(n._serverState){if(n._serverState.upgrade)for(var e in n._serverState.upgrade)if(n._serverState.upgrade.hasOwnProperty(e)){var i=n._serverState.upgrade[e];if(i.socket){if(i.version!=n._serverState.version||i.askFull){var r=n._serverState.data.getData();i.socket.emit("upgrade_"+n._channelId,{version:n._serverState.version,journal:n._serverState.data._journal,data:r})}else{var o=i.last_update[1];i.socket.emit("upgrade_"+n._channelId,{partialFrom:o,partialEnds:n._serverState.data._journal.length,partial:n._serverState.data._journal.slice(o)})}delete n._serverState.upgrade[e]}}if(n._broadcastSocket&&n._policy){var a=n._policy.constructServerToClient(n._serverState);a&&(t||(t=n._broadcastSocket.to(n._channelId)),t.emit("s2c_"+n._channelId,a),n._model.writeToJournal(a.c).then(function(){}))}}},t._groupACL=function(t,n){var e=this;if(!e._acl)return!1;for(var i=t.getUserRoles(),r=!1,o=0;o<i.length;o++)if(e._acl.find("",i[o]+"@",n)){r=!0;break}return r},t._initCmds=function(){if(i||(i={}),!this._cmds){var t=this;this._cmds={treeOfLife:function(n,e,i){return t._groupACL(i,"r")?void t._model.treeOfLife().then(function(t){e(t)}):void e(null)},readBuildTree:function(n,e,i){return t._groupACL(i,"r")?void t._model.readBuildTree().then(function(n){t._model.status().then(function(t){e({status:t,build:n})})}):void e(null)},getForks:function(n,e,i){return t._groupACL(i,"r")?void t._model.getForks().then(function(t){e(t)}):void e(null)},channelStatus:function(n,e,i){return t._groupACL(i,"tc")?void t._model.status().then(function(t){e(t)}):void e(null)},raw:function(n,e,i){e(t._groupACL(i,"tc")?t._chData.getData():null)},fork:function(n,e,i){return t._groupACL(i,"w")?n.data?void t._model.fork(n.data).then(function(t){e(t)}):void e({ok:!1}):void e(null)},snapshot:function(n,e,i){if(console.log("got snapshot command"),!t._groupACL(i,"w"))return void e(null);var r=t._serverState.data.getData();t._doClientUpdate(),console.log("About to call me._model.snapshot "),t._model.snapshot(r).then(function(){t._serverState.version++,t._serverState.data._journal.length=0,t._serverState.last_update[0]=0,t._serverState.last_update[1]=0,console.log("After snapshot "),console.log(t._serverState),t._askChUpgrade(t._channelId),e({ok:!0})})},writeMain:function(n,e,i){return t._groupACL(i,"w")?void t._model.writeFile("main",n.data).then(function(){e({ok:!0})}):void e(null)},readMain:function(n,e,i){return t._groupACL(i,"r")?void t._model.readMain().then(function(t){e(t)}):void e(null)},readMainVersion:function(n,e,i){return t._groupACL(i,"r")?void t._model.readMain(n.data).then(function(t){e(t)}):void e(null)},upgradeRequest:function(n,e,i){return t._groupACL(i,"r")?(t._serverState.upgrade||(t._serverState.upgrade={}),n.data.socket=i,t._serverState.upgrade[i.getId()]=n.data,void e({result:!0})):void e(null)},c2s:function(n,e,i){if(!t._groupACL(i,"w"))return void e(null);for(var r=i.getUserId(),o=n.data.c.length,a=n.data.c,s=(new Date).getTime(),c=0;o>c;c++)a[c][5]=s,a[c][6]=r;var u=t._policy.deltaClientToServer(n.data,t._serverState);t._broadcastSocket||(t._broadcastSocket=i),e(u)},changeFrame:function(n,e,i){if(!t._groupACL(i,"w"))return void e(null);var r=t._tManager.execute(n.data);r.validCnt>0?(n.data.commands.length=r.validCnt,t._model.writeToJournal(n.data.commands).then(function(){i.broadcast.to(n.channelId).emit("frame_"+n.channelId,n),e(r)})):e(r)},writeJournal:function(n,e,i){return t._groupACL(i,"w")?void t._model.writeToJournal(n.data).then(function(){i.broadcast.to(n.channelId).emit("ch_"+n.channelId,n),e({ok:!0})}):void e(null)},readJournal:function(n,e,i){return t._groupACL(i,"r")?void t._model.readJournal().then(function(t){e(t)}):void e(null)},readJournalVersion:function(n,e,i){return t._groupACL(i,"r")?void t._model.readJournal(n.data).then(function(t){e(t)}):void e(null)}}}},t._updateLoop=function(){var t=this;e().every(.2,function(){t._doClientUpdate()})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){this._channelId=t,this._commands=a(t),this._chManager=e,this._model=f(t,n);var i=this;this._model.readBuildTree().then(function(e){for(var r=e.pop(),o=_channelData(t+n.id(),r,[]),a=e.pop();a;)o._journalPointer=0,o._journal.length=0,a.forEach(function(t){o.execCmd(t)}),a=e.pop();i._serverState={data:o,version:i._model._settings.version,last_update:[0,o.getJournalLine()],_done:{}};var s=o.getData();s.__acl&&(i._acl=nfs4_acl(s.__acl)),i._tManager=_channelTransaction(t+n.id(),o),i._policy=_chPolicy(),i._updateLoop(),i._chData=o,i.resolve(!0)}),this._initCmds()}),t.run=function(t,n,e){var i=this._cmds[t.cmd];i&&this._commands.addCommands(function(r){i(t,function(t){n(t),r()},e)})}}(this)},h=function(t,n,e,i,r,o,a,s){var c,u=this;if(!(u instanceof h))return new h(t,n,e,i,r,o,a,s);var f=[t,n,e,i,r,o,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){c=t.apply(u,f)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,r,o,a,s)}else if(c)return c;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,f)}):"function"==typeof u.init&&u.init.apply(u,f)};l.prototype=r.prototype,h._classInfo={name:"_channelController"},h.prototype=new l,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelController=h,this._channelController=h):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelController=h:this._channelController=h}.call(new Function("return this")()),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},e=function(t,n,i,r,o,a,s,c){var u,f=this;if(!(f instanceof e))return new e(t,n,i,r,o,a,s,c);var l=[t,n,i,r,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,r,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};e._classInfo={name:"_channels"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());