(function(){var t={},n=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this);var n=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this);var t=function(){!function(t){var n,e,i,o,r;t.add=function(t,n,i){if(n||i){var o;"[object Array]"===Object.prototype.toString.call(i)?o=i:(o=Array.prototype.slice.call(arguments,2),o||(o=[])),e.push([n,t,o])}else e.push(t)},t.after=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),o[e]={step:Math.floor(1e3*t),fn:n,nextTime:0,remove:!0}},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),o[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){this.polyfill();var t,a;if("undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],i={},o={},r=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<r.length;f++){var u=r[f];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in o)if(o.hasOwnProperty(l)){var h=o[l];h.nextTime<a&&(h.remove?h.nextTime>0?(h.fn(),delete o[l]):h.nextTime=a+h.step:(h.fn(),h.nextTime=a+h.step)),h.until&&h.until<a&&delete o[l]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){r.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=r.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),r.splice(n,1),!0):!1}}(this)},n=function(t,e,i,o,r,a,s,c){var f,u=this;if(!(u instanceof n))return new n(t,e,i,o,r,a,s,c);var l=[t,e,i,o,r,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=n._classInfo.name)return new f(t,e,i,o,r,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};n._classInfo={name:"later"},n.prototype=new t,function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var i=n.length,o=0,r=[],a=new Array(i);return this.then(function(){var t=e();return 0==n.length&&t.resolve([]),n.forEach(function(n,e){n.then?(r.push(n),n.then(function(n){a[e]=n,o++,o==i&&t.resolve(a)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,i){var o;o=this.isArray(n)?n:[n];var r=o.length,a=!1,s=!1,c=0,f=[],u=i||{};return this.then(function(){var n=e();return o.forEach(function(e){e.then?(f.push(e),e.then(function(e){c++,a=t(e,u),(a&&!s||0==s&&r==c)&&(n.resolve(u),s=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(o){e.reject(o)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,e){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(e)&&(this._onReject=e),!e&&this.isFunction(t)){var i=this;n().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,i){i||(i=function(){});var o=new e(t,i),r=this;return 1==this._state&&n().asap(function(){r.fulfill(r.value())}),2==this._state&&n().asap(function(){r.reject(r.rejectReason())}),this._childPromises.push(o),o},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},e=function(t,n,i,o,r,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,o,r,a,s,c);var l=[t,n,i,o,r,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,o,r,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"_promise"},e.prototype=new n;var i=function(){!function(t){var n,e,i,o,r;t.add=function(t,n,i){if(n||i){var o;"[object Array]"===Object.prototype.toString.call(i)?o=i:(o=Array.prototype.slice.call(arguments,2),o||(o=[])),e.push([n,t,o])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),o[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,a;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,a=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],a=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),a||(a=function(t){clearTimeout(t)}),e=[],i={},o={},r=[];var s=0,c=function(){for(var n,a=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var f=0;f<r.length;f++){var u=r[f];u()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in o)if(o.hasOwnProperty(l)){var h=o[l];h.nextTime<a&&(h.fn(),h.nextTime=a+h.step),h.until&&h.until<a&&delete o[l]}t(c),s=a};c(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){r.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=r.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),r.splice(n,1),!0):!1}}(this)},o=function(t,n,e,i,r,a,s,c){var f,u=this;if(!(u instanceof o))return new o(t,n,e,i,r,a,s,c);var l=[t,n,e,i,r,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=o._classInfo.name)return new f(t,n,e,i,r,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};o._classInfo={name:"later"},o.prototype=new i;var r=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"undefined"==typeof t?this.__isA:"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return"undefined"==typeof t?this.__isO:t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t.addCommands=function(t,n){if(this.isArray(t)){var e=this;return t.forEach(function(t){e.addCommands(t)}),this}this._commands.push({fnCmd:t,fnFail:n,async:!0})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._commands||(this._commands=[],this.waitingList=[],this._index=0);var e=this;n||o().every(1/30,function(){e.step()})}),t.step=function(){var t=this._index,n=this._commands.length;if(t!=n){for(var i=e(),o=i,r=e(),a=this;n>t;){var s=this._commands[t];!function(t){o=o.then(function(){var n=e();return t.fnCmd(function(){n.resolve(!0)},function(e){n.resolve(!0),t.fnFail&&t.fnFail(e)}),n}).fail(function(n){t.fnFail&&t.fnFail(n)})}(s),this._index++,t++}return o.then(function(){if(a.waitingList.shift(),r.resolve(!0),a.waitingList.length){var t=a.waitingList[0];t.resolve(!0)}}).fail(function(){}),this.waitingList.push(i),1==this.waitingList.length&&i.resolve(!0),r}}}(this)},a=function(t,n,e,i,o,r,s,c){var f,u=this;if(!(u instanceof a))return new a(t,n,e,i,o,r,s,c);var l=[t,n,e,i,o,r,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=a._classInfo.name)return new f(t,n,e,i,o,r,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};a._classInfo={name:"sequenceStepper"},a.prototype=new r;var s=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){t.exampleCode=function(){socket.on("requestChannel",function(t){if(console.log("Got request channel"),!t)return void console.log("Empty channel data");var n=!1;return t.auth&&(console.log("Authenticating"),console.log(JSON.stringify(t.auth)),t.auth.u&&t.auth.p&&"abba"==t.auth.u&&(n=!0)),n?void me.checkChannelInfo(t,function(n){if(n)return void console.log(n);t.io=io,t.main=me;var e=me.createChannel(t);e.join(socket,t)&&(myChannels.push(e),console.log("the socket is now connected to "+myChannels.length+" channels")),console.log("About to join remote channel..."),me.joinRemoteChannel(t)}):(console.log("*** No authentication from IP ****"),void socket.disconnect("unauthorized"))})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._server=t,this._server.on("connect",function(t){t.on("requestChannel",function(n,e){t.join(n.channelId),e({success:!0,channelId:n.channelId})}),t.on("auth",function(n,e){t.setAuthInfo(n.userId,["users"]),e({success:!0,userId:t.getUserId()})}),t.on("authenticate",function(n,e){t.setAuthInfo(n.userId,["users"]),e({success:!0,userId:t.getUserId()})}),t.on("whoami",function(n,e){e({success:!0,userId:t.getUserId()})}),t.on("channelCommand",function(e,i){if(!t.getUserId())return void i({success:!1,reason:"socket is not authenticated."});if(!t.isInRoom(e.channelId))return void i({success:!1,reason:"not in room"});var o=h(e.channelId,n);o.run(e,function(t){i&&i(t)},t)})})})}(this)},c=function(t,n,e,i,o,r,a,s){var f,u=this;if(!(u instanceof c))return new c(t,n,e,i,o,r,a,s);var l=[t,n,e,i,o,r,a,s];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=c._classInfo.name)return new f(t,n,e,i,o,r,a,s)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};c._classInfo={name:"_serverChannelMgr"},c.prototype=new s,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverChannelMgr=c,this._serverChannelMgr=c):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverChannelMgr=c:this._serverChannelMgr=c}.call(new Function("return this")());var f=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return n||(n={}),n[t]?n[t]:void(n[t]=this)}),t._createChannelDir=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var i=n.split("/"),o=this._fs,r=o,a=e(),s=a,c=this;return i.forEach(function(t){t=t.trim(),0!=t.length&&(a=a.then(function(){return r.isFolder(t)}).then(function(n){return n?!0:r.createDir(t)}).then(function(){return r.getFolder(t)}).then(function(t){r=t}))}),a=a.then(function(){c._folder=r}),s.resolve(!0),a},t._createChannelSettings=function(){var t=this._folder,n=this;return e(function(e){var i=!1;t.isFile("ch.settings").then(function(e){return e?!0:(i=!0,t.writeFile("ch.settings",JSON.stringify({version:1,name:"Initial version",utc:(new Date).getTime(),channelId:n._channelId,journalLine:0})))}).then(function(){return t.readFile("ch.settings")}).then(function(t){var i=JSON.parse(t);n._settings=i,e(n._settings)})})},t._textLinesToArray=function(t){var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t._writeSettings=function(){return this._folder.writeFile("ch.settings",JSON.stringify(this._settings))},t.childForkTree=function(){var t=(this._folder,this);return e(function(n){t.getForks().then(function(i){var o=[],r=[];if(!i||0==i.length)return void n([]);i.forEach(function(n){var e=u(n.to,t._fs);o.push(e.childForkTree())});var a=e();a.all(o).then(function(t){i.forEach(function(n,e){n.children=t[e],r.push(n)}),n(r)}),a.resolve(!0)})})},t.fork=function(t){var n=this._folder,i=this;return e(function(e){var o=i._settings,r={fromJournalLine:o.journalLine,version:1,channelId:t.channelId,fromVersion:o.version,from:i._channelId,to:t.channelId,name:t.name,utc:(new Date).getTime()};n.appendFile("forks",JSON.stringify(r)+"\n").then(function(){var n=u(t.channelId,i._fs);n.then(function(){return n.set(r)}).then(function(){e(r)})})})},t.get=function(t){var n=this._db,i=this;return e(function(e){i.then(function(){var i=n.table("settings");i.get(t).then(function(t){e(t.value)})})})},t.getCurrentVersion=function(){var t=(this._folder,this);return e(function(n){n(t._settings.version)})},t.getForks=function(){var t=this._folder,n=this;return e(function(e){n.then(function(){return t.readFile("forks")}).then(function(t){e(t?n._textLinesToArray(t):[])}).fail(function(){e([])})})},t.incrementVersion=function(){var t=(this._folder,this);return e(function(n){t.then(function(){var e=t._settings;e.version++,e.journalLine=0,t._writeSettings().then(function(){n(e.version)})})})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._channelId=t,this._latestVersion=1,this._fs=n;var e=this;e._createChannelDir(t).then(function(){return e._createChannelSettings()}).then(function(){e.resolve(!0)}).fail(function(t){console.error(t)})}),t.readBuildTree=function(t,n,i){var o=(this._folder,this);return e(t?function(e){var r=u(t,o._fs);r.then(function(){r.readBuildTree(null,n,null).then(function(t){var n=t[0].length;n>i&&t[0].splice(i,n-i),e(t)})})}:function(t){var e,i,r=[];o.then(function(){return o.readMain(n)}).then(function(t){return e=t,o.readJournal(n)}).then(function(n){if(i=n,o._settings.from&&!e){var a=o._settings;o.readBuildTree(a.from,a.fromVersion,a.fromJournalLine).then(function(e){r.push(n),e.forEach(function(t){r.push(t)}),t(r)})}else t([n,e])}).fail(function(t){console.error(t)})})},t.readJournal=function(t){var n=this._folder,i=this,o=t||i._settings.version;return e(function(t){n.readFile("journal."+o).then(function(n){return n?void t(i._textLinesToArray(n)):void t([])}).fail(function(){t([])})})},t.readMain=function(t){var n=this._folder,i=this,o=t||i._settings.version;return 1==o?e(function(t){t(null)}):n.readFile("file."+o)},t.set=function(t,n){var e=(this._folder,this._settings);if(this.isObject(t))for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);else e[t]=n;return this._writeSettings(e)},t.snapshot=function(t){var n=(this._folder,this);return e(function(e){var i;n.incrementVersion().then(function(e){return i=e-1,n.writeMain(t)}).then(function(){n._settings.journalLine=0,e(!0)})})},t.status=function(){var t=(this._folder,this);return e(function(n){t.then(function(){n(t._settings)})})},t.treeOfLife=function(t){var n=(this._folder,this);if(t){var i=u(t,this._fs);return i.treeOfLife()}return e(function(t){n.then(function(){n._settings.from?n.treeOfLife(n._settings.from).then(t):n.childForkTree().then(t)})})},t.writeMain=function(t,n){var e=this._folder,i=this,o=n||i._settings.version;return"string"!=typeof t&&(t=JSON.stringify(t)),e.writeFile("file."+o,t)},t.writeToJournal=function(t){var n=this._folder,i=this;return e(function(e){n.appendFile("journal."+i._settings.version,JSON.stringify(t)+"\n").then(function(){i._settings.journalLine++,i._writeSettings(),e(!0)})})}}(this)},u=function(t,n,e,i,o,r,a,s){var c,f=this;if(!(f instanceof u))return new u(t,n,e,i,o,r,a,s);var l=[t,n,e,i,o,r,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,l)}),"function"==typeof c){if(c._classInfo.name!=u._classInfo.name)return new c(t,n,e,i,o,r,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};f.prototype=e.prototype,u._classInfo={name:"_localChannelModel"},u.prototype=new f,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._localChannelModel=u,this._localChannelModel=u):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._localChannelModel=u:this._localChannelModel=u}.call(new Function("return this")());var l=function(){!function(t){t.on=function(t,n){return this._ev||(this._ev={}),this._ev[t]||(this._ev[t]=[]),this._ev[t].push(n),this},t.trigger=function(t,n,e){if(this._ev&&this._ev[t]){return this._ev[t].forEach(function(t){t(n,e)}),this}}}(this),function(t){var n,e;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t._initCmds=function(){if(e||(e={}),!this._cmds){var t=this;this._cmds={treeOfLife:function(n,e){t._model.treeOfLife().then(function(t){e(t)})},readBuildTree:function(n,e){t._model.readBuildTree().then(function(t){e(t)})},getForks:function(n,e){t._model.getForks().then(function(t){e(t)})},channelStatus:function(n,e){t._model.status().then(function(t){e(t)})},fork:function(n,e){return n.data?void t._model.fork(n.data).then(function(t){e(t)}):void e({ok:!1})},snapshot:function(n,e){return n.data?void t._model.snapshot(n.data).then(function(t){e({ok:!0,snapshot:t})}):void e({ok:!1})},writeMain:function(n,e){t._model.writeFile("main",n.data).then(function(){e({ok:!0})})},readMain:function(n,e){t._model.readMain().then(function(t){e(t)})},readMainVersion:function(n,e){t._model.readMain(n.data).then(function(t){e(t)})},writeJournal:function(n,e,i){t._model.writeToJournal(n.data).then(function(){i.broadcast.to(n.channelId).emit("ch_"+n.channelId,n),e({ok:!0})})},readJournal:function(n,e){t._model.readJournal().then(function(t){e(t)})},readJournalVersion:function(n,e){t._model.readJournal(n.data).then(function(t){e(t)})}}}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._channelId=t,this._commands=a(t),this._model=u(t,n),this._initCmds()}),t.run=function(t,n,e){var i=this._cmds[t.cmd];i&&this._commands.addCommands(function(o){i(t,function(t){n(t),o()},e)})}}(this)},h=function(t,n,e,i,o,r,a,s){var c,f=this;if(!(f instanceof h))return new h(t,n,e,i,o,r,a,s);var u=[t,n,e,i,o,r,a,s];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){c=t.apply(f,u)}),"function"==typeof c){if(c._classInfo.name!=h._classInfo.name)return new c(t,n,e,i,o,r,a,s)}else if(c)return c;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};h._classInfo={name:"_channelController"},h.prototype=new l,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelController=h,this._channelController=h):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelController=h:this._channelController=h}.call(new Function("return this")()),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){}),t.testCase1=function(){var t=_e(document.body).div();t.h1().text("Channel emulator");var n=_serverSocket("localhost",1234),e=(c(n),_clientSocket("localhost",1234));e.on("connect",function(){t.div().text("@Client: Client "+e.getId()+" connected"),e.emit("requestChannel",{id:"The Channel ID and other information about it"},function(n){t.pre().text("Got "+n)})})},t.testCase2=function(t){var t=_e(document.body).div();t.h1().text("Channel emulator");var n=_serverSocket("localhost",1234),e=(c(n),_clientSocket("localhost",1234)),i="f2";e.on("connect",function(){t.div().text("@Client: Client "+e.getId()+" connected"),t.button().text("Auth").on("click",function(){e.emit("authenticate",{userId:prompt("userid")},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("Who Am I").on("click",function(){e.emit("whoami",{},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("joinChannel").on("click",function(){e.emit("requestChannel",{channelId:prompt("database")},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("readBuildTree").on("click",function(){callCord("main").startSession("readBuildTree"),e.emit("channelCommand",{channelId:prompt("database"),cmd:"readBuildTree",data:""},function(n){callCord("main").endSession("readBuildTree"),t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("treeOfLife").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"treeOfLife",data:""},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("fork").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"fork",data:{name:prompt("name"),channelId:prompt("channelId")}},function(n){t.pre().text("Got response "+JSON.stringify(n))})}),t.button().text("snapshot").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"snapshot",data:prompt("data")},function(n){t.pre().text("Got response "+JSON.stringify(n))})}),t.button().text("+write main").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"writeMain",data:prompt("data")},function(n){t.pre().text("Got response "+JSON.stringify(n))})}),t.button().text("+read main").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"readMain",data:""},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("+write").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"writeJournal",data:"someCmd data "+(new Date).getTime()},function(n){t.pre().text("Got response "+JSON.stringify(n))})}),t.button().text("+read").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"readJournal",data:"someCmd data "+(new Date).getTime()},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("+read J version").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"readJournalVersion",data:parseInt(prompt("version"))},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("+read M version").on("click",function(){e.emit("channelCommand",{channelId:i,cmd:"readMainVersion",data:parseInt(prompt("version"))},function(n){t.pre().text("Got response "+JSON.stringify(n,null,2))})}),t.button().text("Clear dbs").on("click",function(){_localDB().clearDatabases(function(t){return"sys.db"!=t.name?!0:void 0})})})},t.testDb=function(t){var n=u("test2");n.writeFile("foobar.txt","Something else").then(function(){n.readFile("foobar.txt").then(function(n){t.pre().text(JSON.stringify(n))})}),n.set("LocalSetting",1234).then(function(){n.get("LocalSetting").then(function(n){t.pre().text(JSON.stringify(n,null,2))})})}}(this)},e=function(t,n,i,o,r,a,s,c){var f,u=this;if(!(u instanceof e))return new e(t,n,i,o,r,a,s,c);var l=[t,n,i,o,r,a,s,c];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=e._classInfo.name)return new f(t,n,i,o,r,a,s,c)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};e._classInfo={name:"_channels"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());