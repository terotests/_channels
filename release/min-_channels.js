(function(){var t={},n=function(){var n=function(){!function(t){var n,e,i,r,o;t.add=function(t,n,i){if(n||i){var r;"[object Array]"===Object.prototype.toString.call(i)?r=i:(r=Array.prototype.slice.call(arguments,2),r||(r=[])),e.push([n,t,r])}else e.push(t)},t.asap=function(t){this.add(t)},t.every=function(t,n,e){e||(e="time"+(new Date).getTime()+Math.random(1e7)),r[e]={step:Math.floor(1e3*t),fn:n,nextTime:0}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){if(!n){var t,s;if(this.polyfill(),"undefined"!=typeof window){var t=window.requestAnimationFrame,s=window.cancelRequestAnimationFrame;["","ms","moz","webkit","o"].forEach(function(n){t||(t=window[n+"RequestAnimationFrame"],s=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"])})}t||(t=function(t){return setTimeout(t,16)}),s||(s=function(t){clearTimeout(t)}),e=[],i={},r={},o=[];var a=0,f=function(){for(var n,s=(new Date).getTime();n=e.shift();)"[object Array]"===Object.prototype.toString.call(n)?n[1].apply(n[0],n[2]):n();for(var u=0;u<o.length;u++){var c=o[u];c()}for(var l in i)if(i.hasOwnProperty(l)){var h=i[l];h[0](h[1]),delete i[l]}for(var l in r)if(r.hasOwnProperty(l)){var h=r[l];h.nextTime<s&&(h.fn(),h.nextTime=s+h.step),h.until&&h.until<s&&delete r[l]}t(f),a=s};f(),n=!0}}),t.once=function(t,n,e){i[t]=[n,e]},t.onFrame=function(t){o.push(t)},t.polyfill=function(){},t.removeFrameFn=function(t){var n=o.indexOf(t);return n>=0?(t._onRemove&&t._onRemove(),o.splice(n,1),!0):!1}}(this)},e=function(t,n,i,r,o,s,a,f){var u,c=this;if(!(c instanceof e))return new e(t,n,i,r,o,s,a,f);var l=[t,n,i,r,o,s,a,f];if(c.__factoryClass)if(c.__factoryClass.forEach(function(t){u=t.apply(c,l)}),"function"==typeof u){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,r,o,s,a,f)}else if(u)return u;c.__traitInit?c.__traitInit.forEach(function(t){t.apply(c,l)}):"function"==typeof c.init&&c.init.apply(c,l)};e._classInfo={name:"later"},e.prototype=new n;var i=function(){!function(t){t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t.all=function(t){var n;n=this.isArray(t)?t:Array.prototype.slice.call(arguments,0);var e=n.length,i=0,o=[],s=new Array(e);return this.then(function(){var t=r();return 0==n.length&&t.resolve([]),n.forEach(function(n,r){n.then?(o.push(n),n.then(function(n){s[r]=n,i++,i==e&&t.resolve(s)},function(n){t.reject(n)})):t.reject("Not list of promises")}),t})},t.collect=function(t,n,e){var i;i=this.isArray(n)?n:[n];var o=i.length,s=!1,a=!1,f=0,u=[],c=e||{};return this.then(function(){var n=r();return i.forEach(function(e){e.then?(u.push(e),e.then(function(e){f++,s=t(e,c),(s&&!a||0==a&&o==f)&&(n.resolve(c),a=!0)},function(t){n.reject(t)})):n.reject("Not list of promises")}),n})},t.fail=function(t){return this.then(null,t)},t.fulfill=function(t){if(!(this._rejected||this._fulfilled&&t!=this._stateValue)){this._fulfilled=!0,this._stateValue=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onFulfill)try{var i=e._onFulfill(t);"undefined"!=typeof i?e.resolve(i):e.fulfill(t)}catch(r){e.reject(r)}else e.fulfill(t)}this._state=1,this.triggerStateChange()}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(this._state=0,this._stateValue=null,this._isAPromise=!0,this._childPromises=[],this.isFunction(t)&&(this._onFulfill=t),this.isFunction(n)&&(this._onReject=n),!n&&this.isFunction(t)){var i=this;e().asap(function(){t(function(t){i.resolve(t)},function(t){i.reject(t)})})}}),t.isFulfilled=function(){return 1==this._state},t.isPending=function(){return 0==this._state},t.isRejected=function(){return 2==this._state},t.onStateChange=function(t){this._listeners||(this._listeners=[]),this._listeners.push(t)},t.reject=function(t){if(!(this._fulfilled||this._rejected&&t!=this._rejectReason)){this._state=2,this._rejected=!0,this._rejectReason=t;for(var n=this._childPromises.length;n--;){var e=this._childPromises.shift();if(e._onReject)try{e._onReject(t),e.reject(t)}catch(i){e.reject(i)}else e.reject(t)}this.triggerStateChange()}},t.rejectReason=function(t){return t?void(this._rejectReason=t):this._rejectReason},t.resolve=function(t){if(!(this._state>0)){if(t==this)return this._rejectReason="TypeError",void this.reject(this._rejectReason);if(this.isObject(t)&&t._isAPromise){if(this._state=t._state,this._stateValue=t._stateValue,this._rejectReason=t._rejectReason,0===this._state){var n=this;t.onStateChange(function(){1==t._state&&n.resolve(t.value()),2==t._state&&n.reject(t.rejectReason())})}return 1==this._state&&this.fulfill(this._stateValue),void(2==this._state&&this.reject(this._rejectReason))}if(this.isObject(t)&&t.then&&this.isFunction(t.then)){var e=!1;try{var n=this;t.then.call(t,function(t){e||(n.resolve(t),e=!0)},function(t){e||(n.reject(t),e=!0)})}catch(i){e||this.reject(i)}}else this._state=1,this._stateValue=t,this.fulfill(t)}},t.state=function(t){return"undefined"!=typeof t&&(this._state=t),this._state},t.then=function(t,n){n||(n=function(){});var i=new r(t,n),o=this;return 1==this._state&&e().asap(function(){o.fulfill(o.value())}),2==this._state&&e().asap(function(){o.reject(o.rejectReason())}),this._childPromises.push(i),i},t.triggerStateChange=function(){var t=this;this._listeners&&(this._listeners.forEach(function(n){n(t)}),this._listeners.length=0)},t.value=function(t){return"undefined"!=typeof t?(this._stateValue=t,this):this._stateValue}}(this)},r=function(t,n,e,i,o,s,a,f){var u,c=this;if(!(c instanceof r))return new r(t,n,e,i,o,s,a,f);var l=[t,n,e,i,o,s,a,f];if(c.__factoryClass)if(c.__factoryClass.forEach(function(t){u=t.apply(c,l)}),"function"==typeof u){if(u._classInfo.name!=r._classInfo.name)return new u(t,n,e,i,o,s,a,f)}else if(u)return u;c.__traitInit?c.__traitInit.forEach(function(t){t.apply(c,l)}):"function"==typeof c.init&&c.init.apply(c,l)};r._classInfo={name:"_promise"},r.prototype=new i;var o=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t.addCommands=function(t,n){if(this.isArray(t)){var e=this;return t.forEach(function(t){e.addCommands(t)}),this}this._commands.push({fnCmd:t,fnFail:n,async:!0})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._commands||(this._commands=[],this.waitingList=[],this._index=0);var i=this;n||e().every(1/30,function(){i.step()})}),t.step=function(){var t=this._index,n=this._commands.length;if(t!=n){for(var e=r(),i=e,o=r(),s=this;n>t;){var a=this._commands[t];!function(t){i=i.then(function(){var n=r();return t.fnCmd(function(){n.resolve(!0)},function(e){n.resolve(!0),t.fnFail&&t.fnFail(e)}),n}).fail(function(n){t.fnFail&&t.fnFail(n)})}(a),this._index++,t++}return i.then(function(){if(s.waitingList.shift(),o.resolve(!0),s.waitingList.length){var t=s.waitingList[0];t.resolve(!0)}}).fail(function(){}),this.waitingList.push(e),1==this.waitingList.length&&e.resolve(!0),o}}}(this)},s=function(t,n,e,i,r,o,a,f){var u,c=this;if(!(c instanceof s))return new s(t,n,e,i,r,o,a,f);var l=[t,n,e,i,r,o,a,f];if(c.__factoryClass)if(c.__factoryClass.forEach(function(t){u=t.apply(c,l)}),"function"==typeof u){if(u._classInfo.name!=s._classInfo.name)return new u(t,n,e,i,r,o,a,f)}else if(u)return u;c.__traitInit?c.__traitInit.forEach(function(t){t.apply(c,l)}):"function"==typeof c.init&&c.init.apply(c,l)};s._classInfo={name:"sequenceStepper"},s.prototype=new o;var a=function(){!function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n,e){this._server=t,this._auth=e;this._server.on("connect",function(t){t.on("requestChannel",function(n,e){t.join(n.channelId),e({success:!0,channelId:n.channelId})}),t.on("auth",function(n,i){e?e.login(n.userId,n.password).then(function(n){if(n.result===!0){var e=n.userId,r=n.groups;t.setAuthInfo(e,r),i({success:!0,userId:t.getUserId(),groups:n.groups})}else i({success:!1,userId:null})}):i({success:!1,userId:null})}),t.on("authenticate",function(n,e){t.setAuthInfo(n.userId,["users"]),e({success:!0,userId:t.getUserId()})}),t.on("whoami",function(n,e){e({success:!0,userId:t.getUserId()})}),t.on("channelCommand",function(e,i){if(!t.getUserId())return void i({success:!1,reason:"socket is not authenticated."});if(!t.isInRoom(e.channelId))return void i({success:!1,reason:"not in room"});var r=h(e.channelId,n);r.run(e,function(t){i&&i(t)},t)})})})}(this)},f=function(t,n,e,i,r,o,s,a){var u,c=this;if(!(c instanceof f))return new f(t,n,e,i,r,o,s,a);var l=[t,n,e,i,r,o,s,a];if(c.__factoryClass)if(c.__factoryClass.forEach(function(t){u=t.apply(c,l)}),"function"==typeof u){if(u._classInfo.name!=f._classInfo.name)return new u(t,n,e,i,r,o,s,a)}else if(u)return u;c.__traitInit?c.__traitInit.forEach(function(t){t.apply(c,l)}):"function"==typeof c.init&&c.init.apply(c,l)};f._classInfo={name:"_serverChannelMgr"},f.prototype=new a,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._serverChannelMgr=f,this._serverChannelMgr=f):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._serverChannelMgr=f:this._serverChannelMgr=f}.call(new Function("return this")());var u=function(){!function(t){var n;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t){return n||(n={}),n[t]?n[t]:void(n[t]=this)}),t._createChannelDir=function(t){var n=t;"/"==n.charAt(0)&&(n=n.substring(1));var e=n.split("/"),i=this._fs,o=i,s=r(),a=s,f=this;return e.forEach(function(t){t=t.trim(),0!=t.length&&(s=s.then(function(){return o.isFolder(t)}).then(function(n){return n?!0:o.createDir(t)}).then(function(){return o.getFolder(t)}).then(function(t){o=t}))}),s=s.then(function(){f._folder=o}),a.resolve(!0),s},t._createChannelSettings=function(){var t=this._folder,n=this;return r(function(e){var i=!1;t.isFile("ch.settings").then(function(e){return e?!0:(i=!0,t.writeFile("ch.settings",JSON.stringify({version:1,name:"Initial version",utc:(new Date).getTime(),channelId:n._channelId,journalLine:0})))}).then(function(){return t.readFile("ch.settings")}).then(function(t){var i=JSON.parse(t);n._settings=i,e(n._settings)})})},t._textLinesToArray=function(t){if(!t||"string"!=typeof t)return[];var n=t.split("\n"),e=[];return n.forEach(function(t){0!=t.trim().length&&e.push(JSON.parse(t))}),e},t._writeSettings=function(){return this._folder.writeFile("ch.settings",JSON.stringify(this._settings))},t.childForkTree=function(){var t=(this._folder,this);return r(function(n){t.getForks().then(function(e){var i=[],o=[];if(!e||0==e.length)return void n([]);e.forEach(function(n){var e=c(n.to,t._fs);i.push(e.childForkTree())});var s=r();s.all(i).then(function(t){e.forEach(function(n,e){n.children=t[e],o.push(n)}),n(o)}),s.resolve(!0)})})},t.fork=function(t){var n=this._folder,e=this;return r(function(i){var r=e._settings,o={fromJournalLine:r.journalLine,version:1,channelId:t.channelId,fromVersion:r.version,from:e._channelId,to:t.channelId,name:t.name,utc:(new Date).getTime()};n.appendFile("forks",JSON.stringify(o)+"\n").then(function(){var n=c(t.channelId,e._fs);n.then(function(){return n.set(o)}).then(function(){i(o)})})})},t.get=function(t){var n=this._db,e=this;return r(function(i){e.then(function(){var e=n.table("settings");e.get(t).then(function(t){i(t.value)})})})},t.getCurrentVersion=function(){var t=(this._folder,this);return r(function(n){n(t._settings.version)})},t.getForks=function(){var t=this._folder,n=this;return r(function(e){n.then(function(){return t.readFile("forks")}).then(function(t){e(t?n._textLinesToArray(t):[])}).fail(function(){e([])})})},t.incrementVersion=function(){var t=(this._folder,this);return r(function(n){t.then(function(){var e=t._settings;e.version++,e.journalLine=0,t._writeSettings().then(function(){n(e.version)})})})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._channelId=t,this._latestVersion=1,this._fs=n;var e=this;e._createChannelDir(t).then(function(){return e._createChannelSettings()}).then(function(){e.resolve(!0)}).fail(function(t){console.error(t)})}),t.readBuildTree=function(t,n,e){var i=(this._folder,this);return r(t?function(r){var o=c(t,i._fs);o.then(function(){o.readBuildTree(null,n,null).then(function(t){var n=t[0].length;n>e&&t[0].splice(e,n-e),r(t)})})}:function(t){var e,r,o=[];i.then(function(){return i.readMain(n)}).then(function(t){return e=t,i.readJournal(n)}).then(function(n){if(r=n,i._settings.from&&!e){var s=i._settings;i.readBuildTree(s.from,s.fromVersion,s.fromJournalLine).then(function(e){o.push(n),e.forEach(function(t){o.push(t)}),t(o)})}else t([n,e])}).fail(function(t){console.error(t)})})},t.readJournal=function(t){var n=this._folder,e=this,i=t||e._settings.version;return r(function(t){n.readFile("journal."+i).then(function(n){return n?void t(e._textLinesToArray(n)):void t([])}).fail(function(){t([])})})},t.readMain=function(t){var n=this._folder,e=this,i=t||e._settings.version;return 1==i?r(function(t){t(null)}):n.readFile("file."+i)},t.set=function(t,n){var e=(this._folder,this._settings);if(this.isObject(t))for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);else e[t]=n;return this._writeSettings(e)},t.snapshot=function(t){var n=(this._folder,this);return r(function(e){var i;n.incrementVersion().then(function(e){return i=e-1,n.writeMain(t)}).then(function(){n._settings.journalLine=0,e(!0)})})},t.status=function(){var t=(this._folder,this);return r(function(n){t.then(function(){n(t._settings)})})},t.treeOfLife=function(t){var n=(this._folder,this);if(t){var e=c(t,this._fs);return e.treeOfLife()}return r(function(t){n.then(function(){n._settings.from?n.treeOfLife(n._settings.from).then(t):n.childForkTree().then(t)})})},t.writeMain=function(t,n){var e=this._folder,i=this,r=n||i._settings.version;return"string"!=typeof t&&(t=JSON.stringify(t)),e.writeFile("file."+r,t)},t.writeToJournal=function(t){var n=this._folder,e=this;return r(function(i){n.appendFile("journal."+e._settings.version,JSON.stringify(t)+"\n").then(function(){e._settings.journalLine++,e._writeSettings(),i(!0)})})}}(this)},c=function(t,n,e,i,r,o,s,a){var f,u=this;if(!(u instanceof c))return new c(t,n,e,i,r,o,s,a);var l=[t,n,e,i,r,o,s,a];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,l)}),"function"==typeof f){if(f._classInfo.name!=c._classInfo.name)return new f(t,n,e,i,r,o,s,a)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,l)}):"function"==typeof u.init&&u.init.apply(u,l)};u.prototype=r.prototype,c._classInfo={name:"_localChannelModel"},c.prototype=new u,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._localChannelModel=c,this._localChannelModel=c):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._localChannelModel=c:this._localChannelModel=c}.call(new Function("return this")());var l=function(){!function(t){var n,e;t.hasOwnProperty("__factoryClass")||(t.__factoryClass=[]),t.__factoryClass.push(function(t,e){return t===!1&&e?void 0:(n||(n={}),n[t]?n[t]:void(n[t]=this))}),t._initCmds=function(){if(e||(e={}),!this._cmds){var t=this;this._cmds={treeOfLife:function(n,e){t._model.treeOfLife().then(function(t){e(t)})},readBuildTree:function(n,e){t._model.readBuildTree().then(function(t){e(t)})},getForks:function(n,e){t._model.getForks().then(function(t){e(t)})},channelStatus:function(n,e){t._model.status().then(function(t){e(t)})},fork:function(n,e){return n.data?void t._model.fork(n.data).then(function(t){e(t)}):void e({ok:!1})},snapshot:function(n,e){return n.data?void t._model.snapshot(n.data).then(function(t){e({ok:!0,snapshot:t})}):void e({ok:!1})},writeMain:function(n,e){t._model.writeFile("main",n.data).then(function(){e({ok:!0})})},readMain:function(n,e){t._model.readMain().then(function(t){e(t)})},readMainVersion:function(n,e){t._model.readMain(n.data).then(function(t){e(t)})},writeJournal:function(n,e,i){t._model.writeToJournal(n.data).then(function(){i.broadcast.to(n.channelId).emit("ch_"+n.channelId,n),e({ok:!0})})},readJournal:function(n,e){t._model.readJournal().then(function(t){e(t)})},readJournalVersion:function(n,e){t._model.readJournal(n.data).then(function(t){e(t)})}}}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._channelId=t,this._commands=s(t),this._model=c(t,n),this._initCmds()}),t.run=function(t,n,e){var i=this._cmds[t.cmd];i&&this._commands.addCommands(function(r){i(t,function(t){n(t),r()},e)})}}(this)},h=function(t,n,e,i,r,o,s,a){var f,u=this;if(!(u instanceof h))return new h(t,n,e,i,r,o,s,a);var c=[t,n,e,i,r,o,s,a];if(u.__factoryClass)if(u.__factoryClass.forEach(function(t){f=t.apply(u,c)}),"function"==typeof f){if(f._classInfo.name!=h._classInfo.name)return new f(t,n,e,i,r,o,s,a)}else if(f)return f;u.__traitInit?u.__traitInit.forEach(function(t){t.apply(u,c)}):"function"==typeof u.init&&u.init.apply(u,c)};h._classInfo={name:"_channelController"},h.prototype=new l,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(t._channelController=h,this._channelController=h):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._channelController=h:this._channelController=h}.call(new Function("return this")()),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},e=function(t,n,i,r,o,s,a,f){var u,c=this;if(!(c instanceof e))return new e(t,n,i,r,o,s,a,f);var l=[t,n,i,r,o,s,a,f];if(c.__factoryClass)if(c.__factoryClass.forEach(function(t){u=t.apply(c,l)}),"function"==typeof u){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,i,r,o,s,a,f)}else if(u)return u;c.__traitInit?c.__traitInit.forEach(function(t){t.apply(c,l)}):"function"==typeof c.init&&c.init.apply(c,l)};e._classInfo={name:"_channels"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());